---
image: docker.io/library/python:3.12

stages:
  - build-image
  - analysis-and-tests
  - security
  - ci-pipeline

flake8:
  tags: ['new-runner']
  stage: analysis-and-tests
  needs: []
  script:
    - pip install flake8
    - flake8 pebbles tests manage.py

pylint:
  tags: ['new-runner']
  stage: analysis-and-tests
  needs: []
  # cache pip downloads and installed packages
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/pip
      - venv/
  script:
    - pip install -r requirements.txt
    - pip install pylint
    - "pylint -j0 pebbles || true" # no failures ATM

tests:
  tags: ['new-runner']
  stage: analysis-and-tests
  needs: []
  # cache pip downloads and installed packages
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    FLASK_APP: pebbles.server:app
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/pip
      - venv/
  script:
    - pip install -r requirements.txt
    - python manage.py test

pip-audit:
  tags: ['new-runner']
  stage: security
  needs: []
  variables:
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    # Example: "ID|expiry-date|reason, ID|expiry-date|reason, ID|expiry-date|reason"
    # ignore specific IDs only, not whole packages
    # Define this in CI/CD variables
    CI_PIP_AUDIT_ALLOWLIST: ""
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths: [ ".cache/pip" ]
  script:
    - pip install --no-cache-dir pip-audit
    - |
      set -euo pipefail

      today="$(date -I)"  # YYYY-MM-DD
      IGNORE_ARGS=()
      IGNORED_COUNT=0

      if [ -n "${CI_PIP_AUDIT_ALLOWLIST:-}" ]; then
        # Split by commas
        IFS=',' read -ra entries <<< "${CI_PIP_AUDIT_ALLOWLIST}"
        for entry in "${entries[@]}"; do
          # Trim spaces
          entry="$(echo "$entry" | xargs)"
          # Split by '|'
          IFS='|' read -r id expires reason <<< "$entry"
          id="$(echo "$id" | xargs)"
          expires="$(echo "$expires" | xargs)"
          reason="$(echo "$reason" | xargs)"

          if [ -z "$id" ] || [ -z "$expires" ]; then
            echo "WARN: malformed allowlist entry: $entry"
            continue
          fi

          if [[ "$expires" > "$today" ]]; then
            IGNORE_ARGS+=("--ignore-vuln" "$id")
            IGNORED_COUNT=$((IGNORED_COUNT+1))
            echo "Ignoring $id until $expires (${reason:-no reason})"
          else
            echo "Allowlist expired for $id on $expires; not ignoring."
          fi
        done
      fi

      echo "Running pip-audit (file-based) – applying ${IGNORED_COUNT} ignore(s)"
      pip-audit -r requirements.txt "${IGNORE_ARGS[@]}"

      echo "Installing dependencies for environment-based audit"
      pip install -r requirements.txt

      echo "Running pip-audit (environment-based) – applying ${IGNORED_COUNT} ignore(s)"
      pip-audit "${IGNORE_ARGS[@]}"

bandit-scan:
  tags: ['new-runner']
  stage: security
  needs: []
  variables:
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    # Example: "ID|expiry-date|reason, ID|expiry-date|reason, ID|expiry-date|reason"
    # Define this in CI/CD variables
    CI_BANDIT_ALLOWLIST: ""
    # include other needed files
    CI_BANDIT_EXCLUDES: "./migrations,./tests"
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths: [ ".cache/pip" ]
  script:
    - pip install --no-cache-dir bandit
    - |
      set -euo pipefail

      today="$(date -I)"  # YYYY-MM-DD
      SKIPS=()
      IGNORED_COUNT=0

      if [ -n "${CI_BANDIT_ALLOWLIST:-}" ]; then
        IFS=',' read -ra entries <<< "${CI_BANDIT_ALLOWLIST}"
        for entry in "${entries[@]}"; do
          entry="$(echo "$entry" | xargs)"
          [ -z "$entry" ] && continue
          IFS='|' read -r id expires reason <<< "$entry"
          id="$(echo "${id:-}" | xargs | tr '[:lower:]' '[:upper:]')"
          expires="$(echo "${expires:-}" | xargs)"
          reason="$(echo "${reason:-}" | xargs)"

          if [ -z "$id" ] || [ -z "$expires" ]; then
            echo "WARN: malformed allowlist entry: '$entry' (need ID|expiry|reason)"
            continue
          fi
          if ! [[ "$id" =~ ^B[0-9]{3}$ ]]; then
            echo "WARN: '$id' does not look like a Bandit test id (e.g., B311). Skipping."
            continue
          fi

          if [[ "$expires" > "$today" ]]; then
            SKIPS+=("$id")
            IGNORED_COUNT=$((IGNORED_COUNT+1))
            echo "Skipping $id until $expires (${reason:-no reason})"
          else
            echo "Allowlist expired for $id on $expires; not skipping."
          fi
        done
      fi

      # Bandit expects a single comma-separated string for -s, like -s "B311,B113".
      # We join the array into SKIP_CSV using a temporary IFS=,.
      # If no active skips, we do not add -s.
      BANDIT_SKIP_OPT=()
      if [ ${#SKIPS[@]} -gt 0 ]; then
        SKIP_CSV="$(IFS=, ; echo "${SKIPS[*]}")"
        BANDIT_SKIP_OPT=(-s "$SKIP_CSV")
        echo "Bandit will skip: $SKIP_CSV"
      fi

      # directories to skip
      BANDIT_EXCLUDE_OPT=()
      if [ -n "${CI_BANDIT_EXCLUDES:-}" ]; then
        EX_CSV="$(echo "$CI_BANDIT_EXCLUDES" | sed 's/[[:space:]]//g')"
        BANDIT_EXCLUDE_OPT=(-x "$EX_CSV")
        echo "Bandit will exclude: $EX_CSV"
      fi

      echo "Running Bandit – ${IGNORED_COUNT} active skip(s)"
      bandit -r . \
        "${BANDIT_SKIP_OPT[@]}" \
        "${BANDIT_EXCLUDE_OPT[@]}" \
        --severity-level "medium"

build-image:
  tags: ['ci-privileged']
  stage: build-image
  needs: []
  image:
    name: moby/buildkit:rootless
  variables:
    DOCKER_CONFIG: /tmp/.docker
  script:
    - mkdir -p "$DOCKER_CONFIG"
    - ln -s /run/secrets/runner-job-secrets/docker_config_ci.json "$DOCKER_CONFIG/config.json"
    - |
      buildctl-daemonless.sh build \
        --frontend=dockerfile.v0 \
        --local context="${CI_PROJECT_DIR}" \
        --local dockerfile="${CI_PROJECT_DIR}" \
        --opt filename="deployment/pebbles.Dockerfile" \
        --output type=image,name="${CI_IMAGE_REPO_CI}/pebbles:${CI_COMMIT_REF_NAME}",push=true \
        ${CI_BUILDKIT_CACHE_OPTIONS}

# call pipeline project
ci-pipeline:
  stage: ci-pipeline
  needs: ['build-image']
  variables:
    PEBBLES_IMAGE_TAG: "${CI_COMMIT_REF_NAME}"
    PEBBLES_COMMIT_REF_NAME: "${CI_COMMIT_REF_NAME}"
    PEBBLES_ENVIRONMENTS_COMMIT_REF_NAME: "${CI_COMMIT_REF_NAME}"
    PEBBLES_DEPLOY_COMMIT_REF_NAME: "${CI_COMMIT_REF_NAME}"
  trigger:
    project: pebbles/cicd-pipeline
    branch: main
    strategy: depend
